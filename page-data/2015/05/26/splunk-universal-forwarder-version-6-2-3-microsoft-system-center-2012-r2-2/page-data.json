{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2015/05/26/splunk-universal-forwarder-version-6-2-3-microsoft-system-center-2012-r2-2/",
    "result": {"data":{"site":{"siteMetadata":{"title":"RFaircloth Data Nerd"}},"markdownRemark":{"id":"ed30e246-0b86-5158-b052-7e7ad2f0b8c7","excerpt":"Author: Ryan Faircloth Summary: Rapid deployment of the universal forwarder in a production environment is possible with a minimal amount of risk for the…","html":"<p>Author: Ryan Faircloth</p>\n<p>Summary: Rapid deployment of the universal forwarder in a production environment is possible with a minimal amount of risk for the customer. The installation of a universal forwarder can be performed at any time without impact to the production system and without reboot. A small caution is required in that if an existing MSI installation has created on reboot actions the installation of the Splunk universal forwarder or any other MSI may trigger a reboot by the SCCM client.</p>\n<p>[TOC]</p>\n<h1>Overview</h1>\n<p>This guide will deploy the universal forwarder to all servers with a supported version of the Microsoft Windows Server operating system.</p>\n<ul>\n<li>Create a new folder to contain Splunk related collections</li>\n<li>Create one or more collection containing all systems which should receive the universal forwarder.</li>\n<li>Create a collection containing all systems where any version of the universal forwarder -has been deployed</li>\n<li>Create an application definition to deploy the universal forwarder without configuration</li>\n<li>Create an application definition to deploy an upgrade to the universal forwarder without configuration</li>\n<li>Create a package containing a powershell script to configure the universal forwarder</li>\n<li>Deploy the configuration script using a task sequence</li>\n</ul>\n<h1>Prerequisite Steps</h1>\n<table>\n<thead>\n<tr>\n<th>Task</th>\n<th>Responsible</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Create CNAME for Deployment Server</td>\n<td>DNS Admin</td>\n</tr>\n<tr>\n<td>Install Splunk Enterprise on Server</td>\n<td>Splunk Admin</td>\n</tr>\n<tr>\n<td>Configure Splunk Instance as Deployment Server</td>\n<td>Splunk Admin</td>\n</tr>\n</tbody>\n</table>\n<h1>Step by Step</h1>\n<h2>Create the deployment collection folder</h2>\n<ol>\n<li>Navigate to Device Collections</li>\n<li>Right click</li>\n<li>Create new folder</li>\n<li>Name the new folder “Splunk Universal Forwarders”</li>\n<li>Navigate to the new folder</li>\n</ol>\n<h2>Create a collection for deployment</h2>\n<ol>\n<li>Right click and choose ““Create New Device Collection”</li>\n<li>Name the collection “Splunk Deployment Collection for Servers”</li>\n<li>Select “All Desktop and Server Clients” as the limiting collection<br>\n<img src=\"https://i0.wp.com/www.rfaircloth.com/wp-content/uploads/2015/05/wpid-1_CreateDeviceCollection.png?w=1100\" alt=\"Create Device Collection\" title=\"Create Device Collection\"></li>\n<li>Click Next</li>\n<li>Click Add to define the criteria used to determine which devices will receive the Universal Forwarder</li>\n<li>Click Query</li>\n<li>Name the Query “Server OS”</li>\n<li>Click Edit</li>\n<li>Click Show query language</li>\n<li>Enter the following query:<br>\n<code class=\"language-text\">sql&lt;br>&lt;/br>select SMS_R_SYSTEM.ResourceID,&lt;br>&lt;/br>SMS_R_SYSTEM.ResourceType,&lt;br>&lt;/br>SMS_R_SYSTEM.Name,SMS_R_SYSTEM.SMSUniqueIdentifier,&lt;br>&lt;/br>SMS_R_SYSTEM.ResourceDomainORWorkgroup,SMS_R_SYSTEM.Client&lt;br>&lt;/br>from SMS_R_System&lt;br>&lt;/br>inner join&lt;br>&lt;/br>SMS_G_System_OPERATING_SYSTEM on SMS_G_System_OPERATING_SYSTEM.ResourceId = SMS_R_System.ResourceId&lt;br>&lt;/br>where&lt;br>&lt;/br>SMS_G_System_OPERATING_SYSTEM.ProductType = 2&lt;br>&lt;/br>or SMS_G_System_OPERATING_SYSTEM.ProductType = 3&lt;br>&lt;/br></code></li>\n<li>Click OK</li>\n<li>Click OK again</li>\n<li>Enable Incremental Update by checking the box</li>\n<li>Click Next</li>\n<li>Click Next</li>\n<li>Click Close</li>\n</ol>\n<p>> Note: the collection will contain zero members until the update collection background task completes</p>\n<h2>Create a collection of all successfully deployed universal forwarders</h2>\n<ol>\n<li>Right click and choose “Create New Device Collection”</li>\n<li>Name the collection “Splunk Deployment Collection for Deployed Forwarders”</li>\n<li>Select “All Desktop and Server Clients” as the limiting collection</li>\n<li>Click Next</li>\n<li>Click Add to define the criteria used to determine which devices will receive the Universal Forwarder</li>\n<li>Click Query</li>\n<li>Name the Query “Server OS”</li>\n<li>Click Edit</li>\n<li>Click Show query language</li>\n<li>Enter the following query: <img src=\"https://i0.wp.com/www.rfaircloth.com/wp-content/uploads/2015/05/wpid-2_DeviceCollectionQueryExample.png?w=1100\" alt=\"\"></li>\n</ol>\n<p><code class=\"language-text\">sql&lt;br>&lt;/br>Select&lt;br>&lt;/br>SMS_R_SYSTEM.ResourceID,&lt;br>&lt;/br>SMS_R_SYSTEM.ResourceType,&lt;br>&lt;/br>SMS_R_SYSTEM.Name,&lt;br>&lt;/br>SMS_R_SYSTEM.SMSUniqueIdentifier,&lt;br>&lt;/br>SMS_R_SYSTEM.ResourceDomainORWorkgroup,&lt;br>&lt;/br>SMS_R_SYSTEM.Client&lt;br>&lt;/br>from SMS_R_System&lt;br>&lt;/br>inner join&lt;br>&lt;/br>SMS_G_System_ADD_REMOVE_PROGRAMS on SMS_G_System_ADD_REMOVE_PROGRAMS.ResourceID = SMS_R_System.ResourceId&lt;br>&lt;/br>inner join&lt;br>&lt;/br>SMS_G_System_INSTALLED_SOFTWARE on SMS_G_System_INSTALLED_SOFTWARE.ResourceID = SMS_R_System.ResourceId&lt;br>&lt;/br>inner join&lt;br>&lt;/br>SMS_G_System_ADD_REMOVE_PROGRAMS_64 on&lt;br>&lt;/br>SMS_G_System_ADD_REMOVE_PROGRAMS_64.ResourceId = SMS_R_System.ResourceId&lt;br>&lt;/br>where&lt;br>&lt;/br>SMS_G_System_ADD_REMOVE_PROGRAMS.DisplayName = \"UniversalForwarder\"&lt;br>&lt;/br>and SMS_G_System_ADD_REMOVE_PROGRAMS_64.DisplayName = \"UniversalForwarder\"&lt;br>&lt;/br>or SMS_G_System_INSTALLED_SOFTWARE.ProductName = \"UniversalForwarder\"&lt;br>&lt;/br>order by SMS_R_System.Name&lt;br>&lt;/br></code> 11. Click OK 12. Click OK again 13. Enable Incremental Update by checking the box 14. Click Next 15. Click Next 16. Click Close</p>\n<blockquote>\n<p>Note: the collection will contain zero members until the update collection background task completes</p>\n</blockquote>\n<h2>Create Application Definitions</h2>\n<p>Download both the 32bit and 64bit versions of the Splunk Universal Forwarder into the source folder structure used for SCCM deployment applications. Do this for all versions currently deployed as well as the new version to be deployed.</p>\n<blockquote>\n<p>In general the locations are similar to the path:<br>\n\\\\servername\\source\\vendor\\product\\version\\bitness<br>\n\\\\servername\\source\\Splunk\\UniversalForwarder\\6.2.3\\x86</p>\n</blockquote>\n<p>Create the application definition for the oldest deployed version of the Univeral Forwarder first.</p>\n<ol>\n<li>Navigate to Applications in the Software Library screen</li>\n<li>Right click and create a new folder for Splunk definitions</li>\n<li>Right click on the new folder and choose Create New Application</li>\n<li>Locate the 64 bit MSI for this product version <img src=\"https://i0.wp.com/www.rfaircloth.com/wp-content/uploads/2015/05/wpid-3_1_ApplicationDef.png?w=1100\" alt=\"\"></li>\n<li>Click Next</li>\n<li>Click Next again</li>\n<li>Update the definition with the following information</li>\n</ol>\n<ul>\n<li>Name (Include version Number and bitness Version number i.e. Universal Forwarder 6.2.3 (x64)</li>\n<li>Publisher</li>\n<li>Version</li>\n<li>Update the command line by removing “/q” and appending “/quiet AGREETOLICENSE=Yes”\n<blockquote>\n<p>Note it is very important that /q is replaced by /quiet<br>\n<img src=\"https://i0.wp.com/www.rfaircloth.com/wp-content/uploads/2015/05/wpid-3_2_ApplicationDef.png?w=1100\" alt=\"\"></p>\n</blockquote>\n</li>\n</ul>\n<ol start=\"8\">\n<li>Click Next</li>\n<li>Click Next</li>\n<li>Click Close</li>\n<li>Right click on the new application definition and click properties</li>\n<li>Select the deployment type tab</li>\n<li>Select the first deployment and click edit</li>\n<li>Select the program tab</li>\n<li>update the uninstall command replacing /q with /quiet</li>\n<li>select the third browse next to product code and select the MSI</li>\n<li>Click requirements</li>\n<li>Click add</li>\n<li>Select category = device condition = operating system and provide the supported 64bit operating systems <img src=\"https://i0.wp.com/www.rfaircloth.com/wp-content/uploads/2015/05/wpid-3_3_ApplicationDef.png?w=1100\" alt=\"\"></li>\n<li>Create and additional requirements appropriate for your environment such as memory and disk space free</li>\n<li>Click OK</li>\n<li>Click OK again</li>\n<li>Add a new deployment type define the 32 bit MSI type using the information above</li>\n<li>Edit the new type using the information above to set the product MSI and verify requirements</li>\n<li>Select the supersedence tab</li>\n<li>click add</li>\n<li>Click Browse and select the oldest prior version of the application deployed to replace</li>\n<li>Map old deployment type to new ensuring the types match <img src=\"https://i0.wp.com/www.rfaircloth.com/wp-content/uploads/2015/05/wpid-3_4_ApplicationDef.png?w=1100\" alt=\"\"></li>\n<li>Click OK</li>\n<li>Add any other replacements required</li>\n<li>Verify your work and click OK</li>\n</ol>\n<blockquote>\n<p>Repeat the application creation process for all versions of the UF in production If you are upgrading monitor your deployment progress You may continue with this procedure while the Universal Forwarder application is deployed.</p>\n</blockquote>\n<h2>Create a Configuration Script</h2>\n<ol>\n<li>Create a source folder to contain the configuration script for example \\\\servername\\source\\splunk\\scripts\\UF_Config_V1</li>\n<li>The following script can be used as a template for the appropriate configuration for your site. At minimum the deployment server FQDN must be customized. Name the script configure.ps1</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">#Splunk Configuration Script for SCCM Task Sequence\n#Locate Splunk based on the MSI registration\n\nfunction Get-IniContent ($filePath)\n{\n$ini = @{}\n$section=\"GLOBAL\"\n$CommentCount=0\nswitch -regex -file $FilePath\n{\n\n \"^\\[(.+)\\]\" # Section\n{\n$section = $matches[1]\n$ini[$section] = @{}\n$CommentCount = 0\n}\n\"^(\\#.*)$\" # Comment\n{\n$value = $matches[1]\n$CommentCount = $CommentCount + 1\n$name = \"Comment\" + $CommentCount\n#$ini[$section][$name] = $value\n}\n\"(.+?)\\s*=(.*)\" # Key\n{\n$name,$value = $matches[1..2]\n$ini[$section][$name] = $value\n}\n}\nreturn $ini\n}\n\n$location =\"C:\\Program Files\\SplunkUniversalForwarder\\\"\n\n#note if splunk may not be installed at the default location uncomment the following lines\n#$list = Get-WmiOBject -Class Win32_Product | Where-Object {\n# $_.Name -eq 'UniversalForwarder' -or $_.Name -eq 'Splunk' }\n\n#$splunkprod = $list | where-Object { $_.InstallLocation }\n\n#$location = $splunkprod.InstallLocation\n\n$scriptappver = 2\n\n$splunkcmd = $location + \"bin\\splunk.exe\"\n$staticapp = $location + \"etc\\apps\\_static_all_universalforwarder\\\"\n$staticdefault = $staticapp + \"default\\\"\n$staticlocal = $staticapp + \"local\\\"\n\n$staticdefault_dc = $staticdefault + \"deploymentclient.conf\"\n$staticlocal_dc = $staticlocal + \"deploymentclient.conf\"\n$staticdefault_app = $staticdefault + \"app.conf\"\n\nif (!(Test-Path -Path $staticapp)) {new-item -ItemType Directory -Path $staticapp}\n\nif (!(Test-Path -Path $staticdefault)) {new-item -ItemType Directory -Path $staticdefault}\n\nif (!(Test-Path -Path $staticlocal)) {new-item -ItemType Directory -Path $staticlocal}\n\nif (!(Test-Path -Path $staticdefault_app))\n{\n new-item -path $staticdefault_app -ItemType File\n Add-Content -Path $staticdefault_app -Value \"#Generated by scripting\"\n #Add-Content -Path $staticdefault_app -Value \"`r`n\"\n Add-Content -Path $staticdefault_app -Value \"[_static_all_universalforwarder]\"\n Add-Content -Path $staticdefault_app -Value \"author=Ryan Faircloth\"\n Add-Content -Path $staticdefault_app -Value \"description=Script Generated UF default configuration applied by SCCM\"\n Add-Content -Path $staticdefault_app -Value \"version=1\"\n Add-Content -Path $staticdefault_app -Value \"[ui]\"\n Add-Content -Path $staticdefault_app -Value \"is_visible = false\"\n}\n\n$appconf = Get-IniContent $staticdefault_app\n$appver = $appconf[“_static_all_universalforwarder”][“version”]\n\nif ($appver -ne $scriptappver)\n{\nif (!(Test-Path -Path $staticdefault_dc))\n{\n new-item -path $staticdefault_dc -ItemType File\n Add-Content -Path $staticdefault_dc -Value \"#Generated by scripting\"\n Add-Content -Path $staticdefault_dc -Value \"[deployment-client]\"\n Add-Content -Path $staticdefault_dc -Value \"clientName=ScriptDeployed|\"\n Add-Content -Path $staticdefault_dc -Value \"[target-broker:deploymentServer]\"\n Add-Content -Path $staticdefault_dc -Value \"targetUri=srvsplunk.ad.domainname.com:8089\"\n Add-Content -Path $staticdefault_dc -Value \"\"\n\n}\n\n&amp; $splunkcmd \"restart\"\n}\n</code></pre></div>\n<h2>Create a Package to contain the configuration script</h2>\n<ol>\n<li>Create a new package folder Splunk</li>\n<li>Create a new folder on a network share Splunk_config_vx where X is the version of the script and include a customized version of the config script provided</li>\n<li>Right click on the package folder create package</li>\n<li>Name the package Splunk Configuration Script v1</li>\n<li>Select the source folder <img src=\"https://i0.wp.com/www.rfaircloth.com/wp-content/uploads/2015/05/wpid-3_PackageDef.png?w=1100\" alt=\"\"></li>\n<li>Click Next</li>\n<li>Click do not create a program</li>\n<li>Click next</li>\n<li>Click next</li>\n<li>Click Close</li>\n<li>Right click on the package and click “Distribute Content” using appropriate options for the environment. <strong><em>Do not click deploy</em></strong></li>\n<li>Create the Task Sequence</li>\n<li>Crea a new Task Sequence Folder “Splunk”</li>\n<li>Right click the Task Sequence Folder Create Task Sequence</li>\n<li>Name the task Splunk Config Vx</li>\n<li>Click Next</li>\n<li>Click Next</li>\n<li>Click Close</li>\n<li>Right click on the task sequence</li>\n<li>Click properties</li>\n<li>Click the advance tab</li>\n<li>Select suppress task sequence notifications and disable this task sequence on computers where it is deployed</li>\n<li>Right click on the task sequence and choose edit</li>\n<li>Click Add General —> powershell script</li>\n<li>Set the script name i.e. configure.ps1 and execution policy=bypass</li>\n<li>Click OK</li>\n<li>Right click on the task and deploy to the deployed collection created second above</li>\n</ol>\n<h2>Create the configuration task sequence</h2>\n<ol>\n<li>Navigate to Software Library</li>\n<li>Navigate to Operating System Deployment</li>\n<li>Navigate to Task Sequence</li>\n<li>Optional Create a new folder called Splunk</li>\n<li>Right click and Create a new task sequence</li>\n<li>Select Custom Sequence <img src=\"https://i0.wp.com/www.rfaircloth.com/wp-content/uploads/2015/05/wpid-4_1_TaskSequence.png?w=1100\" alt=\"\"></li>\n<li>Click Next</li>\n<li>Name the sequence i.e. <em>Splunk Configuration Script Vx</em></li>\n<li>Click Next</li>\n<li>Click Next</li>\n<li>Click Close</li>\n<li>Right click on the task sequence</li>\n<li>Click properties</li>\n<li>Click the advanced tab</li>\n</ol>\n<ul>\n<li>Select suppress task sequence notifications</li>\n<li>disable this task sequence on computers where it is deployed<br>\n<img src=\"https://i0.wp.com/www.rfaircloth.com/wp-content/uploads/2015/05/wpid-4_2_TaskSequence.png?w=1100\" alt=\"\"></li>\n</ul>\n<ol start=\"15\">\n<li>Click Ok</li>\n<li>Right click on the task sequence and choose edit</li>\n</ol>\n<ul>\n<li>Click Add General —> powershell script</li>\n<li>Set the script name and execution policy=bypass<br>\n<img src=\"https://i0.wp.com/www.rfaircloth.com/wp-content/uploads/2015/05/wpid-4_3_TaskSequence.png?w=1100\" alt=\"\"></li>\n</ul>\n<ol start=\"17\">\n<li>Click OK</li>\n<li>Right click on the task and deploy to the deployed collection created second above</li>\n</ol>","frontmatter":{"title":"Splunk Universal Forwarder Version 6.2.3+ Microsoft System Center 2012 R2","date":"May 26, 2015","description":null}},"previous":{"fields":{"slug":"/2015/01/25/staying-date-updates-update-smart-microsoft-secunia/"},"frontmatter":{"title":"Staying up to date with the updates, update smart with Microsoft and Secunia"}},"next":{"fields":{"slug":"/2015/05/28/splunk-universal-forwarder-version-6-2-3-ubuntu-15-04/"},"frontmatter":{"title":"Splunk Universal Forwarder Version 6.2.3+ Ubuntu 15.04"}}},"pageContext":{"id":"ed30e246-0b86-5158-b052-7e7ad2f0b8c7","previousPostId":"9304e4d1-85c0-5c8b-a946-af9bc8a90fc5","nextPostId":"e439122b-a097-5cf8-83ad-3ab1ed69ddc5"}},
    "staticQueryHashes": ["2841359383","3257411868"]}