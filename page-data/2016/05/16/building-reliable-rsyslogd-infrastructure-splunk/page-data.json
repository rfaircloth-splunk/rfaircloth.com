{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2016/05/16/building-reliable-rsyslogd-infrastructure-splunk/",
    "result": {"data":{"site":{"siteMetadata":{"title":"RFaircloth Data Nerd"}},"markdownRemark":{"id":"5faca7fb-6677-51b0-a0d8-e5fb3cc7d8de","excerpt":"Overview Preparation of a base infrastructure for high availability ingestion of syslog data with a default virtual server and configuration for test data on…","html":"<h2>Overview</h2>\n<p>Preparation of a base infrastructure for high availability ingestion of syslog data with a default virtual server and configuration for test data on boarding. Reference technology specific on boarding procedures.</p>\n<h2>Requirement</h2>\n<p>Multiple critical log sources require a reliable syslog infrastructure. The following attributes must be present for the solution</p>\n<ul>\n<li>Enterprise supported linux such as RHEL, OR Centos, or recent Ubuntu LTS</li>\n<li>Syslog configuration which will not impact the logging of the host on which syslog is configured</li>\n<li>External Load Balancing utilizing DNAT lacking available enterprise shared services NLB devices KEMP offers a free to use version of their product up to 20 Mbs suitable for many cases</li>\n</ul>\n<h2>Technical Environment</h2>\n<p>The following systems will be created utilizing physical or virtual systems. System specifications will vary due estimated load.</p>\n<ul>\n<li>servers in n+1 configuration\n<ul>\n<li>Minimum 2 GB memory</li>\n<li>Minimum 2 x 2.3 GHZ core</li>\n<li>Mounts configure per enterprise standard with the following additions\n<ul>\n<li>/opt/splunk 40 GB XFS</li>\n<li>/var/splunk-syslog 40 GB XFS</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Dual interfaced load balancer configured for DNAT support.</li>\n<li>Subnet with at minimum the number of unique syslog sources (technologies) additional space for growth is strongly advised</li>\n<li>Subnet allocated for syslog servers</li>\n</ul>\n<h2>Solution Prepare the rsyslogd servers</h2>\n<p>The following procedure will be utilized to prepare the rsyslogd servers</p>\n<p>. Install the base operating system and harden according to enterprise standards 2. Provision and mount the application partitions /opt/splunk and /var/splunk-syslog according the estimates required for your environment.</p>\n<ol>\n<li>Note 1 typical configuration utilize noatime on both mounts</li>\n<li>Note 2 typical configuration utilizes no execute on the syslog mount</li>\n<li>Create the following directories for modular configuration of rsyslogd</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  mkdir -p /etc/rsyslog.d/conf.d/splunk-0-rules\n  mkdir -p /etc/rsyslog.d/conf.d/splunk-1-inputs</code></pre></div>\n<ol start=\"4\">\n<li>Create the Splunk master syslog-configuration /etc/rsyslog.d/splunk.conf</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  #\n  # Include all config files for splunk /etc/rsyslog.d/\n  #\n\n  $IncludeConfig /etc/rsyslog.d/splunk-0-rules/*.conf\n  $IncludeConfig /etc/rsyslog.d/splunk-1-inputs/*.conf\n</code></pre></div>\n<ol start=\"5\">\n<li>Create the catch all syslog collection source. /etc/rsyslog.d/splunk-1-inputs/default.conf</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  #define syslog source\n  input(type=\"imptcp\" port=\"8100\" ruleset=\"default_file\");\n  input(type=\"impudp\" port=\"8100\" ruleset=\"default_file\");</code></pre></div>\n<ol start=\"6\">\n<li>Define a rule for all incoming data on the default port /etc/rsyslog.d/splunk-0-rules/default.conf</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  ruleset(name=\"default_file\"){\n      $RulesetCreateMainQueue\n      $template DynaFile,\"/var/splunk-syslog/default/%HOSTNAME%.log\"\n      *.* -?DynaFile\n      stop\n  }</code></pre></div>\n<ol start=\"7\">\n<li>Ensure splunk can read from the syslog folders. The paths should exist at this point due to the dedicated mount</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  chown -R splunk:splunk /var/splunk-syslog\n  chmod -R 0755 /var/splunk-syslog</code></pre></div>\n<ol start=\"8\">\n<li>Reload rsyslogd</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  systemctl reload rsyslog</code></pre></div>\n<ol start=\"9\">\n<li>Create log rotation configuration /etc/logrotate.d/splunk-syslog</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  /var/splunk-syslog/*/*.log\n  {\n      daily\n      compress\n      delaycompress\n      rotate 4\n      ifempty\n      maxage 7\n      nocreate\n      missingok\n      sharedscripts\n      postrotate\n      /bin/kill -HUP `cat /var/run/syslogd-ng.pid 2> /dev/null` 2> /dev/null || true\n      endscript\n  }</code></pre></div>\n<ol start=\"10\">\n<li>Allow firewall access to the new ports (RHEL based)</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  firewall-cmd --permanent --zone=public --add-port=8100/tcp\n  firewall-cmd --permanent --zone=public --add-port=8100/udp\n  firewall-cmd --reload</code></pre></div>\n<h2>Solution Prepare KEMP Loadbalancer</h2>\n<ul>\n<li>Deploy virtual load balancer to hypervisor with two virtual interfaces\n<ul>\n<li>#1 Enterprise LAN</li>\n<li>#2 Private network for front end of syslog servers</li>\n</ul>\n</li>\n<li>Login to the load balancer web UI</li>\n<li>Apply free or purchased license</li>\n<li>Navigate to network setup\n<ul>\n<li>Set eth0 external ip</li>\n<li>Set eth1 internal ip</li>\n</ul>\n</li>\n<li>Add the first virtual server (udp)\n<ul>\n<li>Navigate to Virtual Services –> Add New</li>\n<li>set the virtual address</li>\n<li>set port 514</li>\n<li>set port name syslog-default-8100-udp</li>\n<li>set protocol udp</li>\n<li>Click Add this virtual service</li>\n<li>Adjust virtual service settings\n<ul>\n<li>Force Layer 7</li>\n<li>Transparency</li>\n<li>set persistence mode source ip</li>\n<li>set persistence time 6 min</li>\n<li>set scheduling method lest connected</li>\n<li>Use Server Address for NAT</li>\n<li>Click Add new real server - Enter IP of syslog server 1 - Enter port 8100</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Add the first virtual server (tcp)\n<ul>\n<li>Navigate to Virtual Services –> Add New</li>\n<li>set the virtual address</li>\n<li>set port 514</li>\n<li>set port name syslog-default-8100-tcp</li>\n<li>set protocol tcp</li>\n<li>Click Add this virtual service</li>\n<li>Adjust virtual service settings\n<ul>\n<li>Service type Log Insight</li>\n<li>Transparency</li>\n<li>set scheduling method lest connected</li>\n<li>TCP Connection only check port 8100</li>\n<li>Click Add new real server - Enter IP of syslog server 1 - Enter port 8100</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Repeat the add virtual server process for additional resource servers</li>\n</ul>\n<h2>Update syslog server routing configuration</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Update the default gateway of the syslog servers to utilize the NLB internal interface</code></pre></div>\n<h2>Validation procedure</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">from a linux host utilize the following commands to validate the NLB and log servers are working together\nlogger -P 514 -T -n &lt;vip_ip> \"test TCP\"\nlogger -P 514 -d -n &lt;vip_ip> \"test UDP\"\nverify the messages are logged in /var/splunk-syslog/default</code></pre></div>\n<h2>Prepare Splunk Infrastructure for syslog</h2>\n<ul>\n<li>Follow procedure for deployment of the Universal Forwarder with deployment client ensure the client has has valid outputs and base configuration</li>\n<li>Create the indexes syslog and syslog_unclassified</li>\n<li>Deploy input configuration for the default input</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[monitor:///var/splunk-syslog/default/*.log]\nhost_regex = .*\\/(.*)\\.log\nsourcetype = syslog\nsource = syslog_enterprise_default\nindex = syslog_unclassified\ndisabled = enabled</code></pre></div>\n<ul>\n<li>Validate the index contains data</li>\n</ul>","frontmatter":{"title":"Building reliable rsyslogd infrastructure for Splunk","date":"May 16, 2016","description":null}},"previous":{"fields":{"slug":"/2016/02/18/354/"},"frontmatter":{"title":"Ghost Detector (CVE-2015-7547)"}},"next":{"fields":{"slug":"/2016/05/16/building-high-performance-low-latency-rsyslog-splunk/"},"frontmatter":{"title":"Building High Performance low latency rsyslog for Splunk"}}},"pageContext":{"id":"5faca7fb-6677-51b0-a0d8-e5fb3cc7d8de","previousPostId":"3562be1d-f1a3-5473-8351-982bc88b1131","nextPostId":"de7f23a7-e279-5fc3-b9fc-9f9e4094a22b"}},
    "staticQueryHashes": ["2841359383","3257411868"]}